<!DOCTYPE html>

<html>
  <head>
    <title>News Map</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.0.2/jquery.min.js"></script>
    <!-- bootstrap (navigation bar) -->
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/navibar_style.css">
    <!-- news drawer -->
    <link rel="stylesheet" href="/css/news_drawer.css">
    <!-- news board -->
    <link rel="stylesheet" href="/css/news_board.css">

    <!-- Google Map -->
    <style type="text/css">
      html, body, #map-canvas { height: 100%; margin: 0; padding-top: 25px; z-index: 0;}
    </style>
    <script
      var API_KEY="AIzaSyCJlrhTKQ6xy8CGPU6W2d-kcogBZ6_hBY0";
      src="https://maps.googleapis.com/maps/api/js?key=" + API_KEY>
    </script>
    <script>

      var LOCATION_TAIPEI_STATION = new google.maps.LatLng(25.0477505, 121.5170599);
      var LOCATION_NTU = new google.maps.LatLng(25.0162596, 121.5381254);

      var map;

      function initialize() {
        var mapOptions = {
          center: LOCATION_TAIPEI_STATION,
          zoom: 12,
          /*styles : [{"featureType":"administrative","elementType":"labels.text.fill","stylers":[{"color":"#444444"}]},{"featureType":"landscape","elementType":"all","stylers":[{"color":"#f2f2f2"}]},{"featureType":"poi","elementType":"all","stylers":[{"visibility":"off"}]},{"featureType":"road","elementType":"all","stylers":[{"saturation":-100},{"lightness":45}]},{"featureType":"road.highway","elementType":"all","stylers":[{"visibility":"simplified"}]},{"featureType":"road.arterial","elementType":"labels.icon","stylers":[{"visibility":"off"}]},{"featureType":"transit","elementType":"all","stylers":[{"visibility":"off"}]},{"featureType":"water","elementType":"all","stylers":[{"color":"#46bcec"},{"visibility":"on"}]}] */
          styles: [{"featureType":"road","elementType":"geometry","stylers":[{"lightness":100},{"visibility":"simplified"}]},{"featureType":"water","elementType":"geometry","stylers":[{"visibility":"on"},{"color":"#C6E2FF"}]},{"featureType":"poi","elementType":"geometry.fill","stylers":[{"color":"#C5E3BF"}]},{"featureType":"road","elementType":"geometry.fill","stylers":[{"color":"#D1D1B8"}]}]
        };
        map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);


        // TODO highlight some position.
        addClickMapListener();

      }

      function addClickMapListener() {
        google.maps.event.addListener(map, "click", function (e) {
            var latLng = e.latLng;
            updateClickPosition(latLng.lat(), latLng.lng());
        });
      }

      google.maps.event.addDomListener(window, 'load', initialize);
    </script>
  </head>
  <body>
    <!-- fixed navibar -->
    <nav class="fixed-nav-bar">
      <div class="container-fluid">
        <div class="navbar-header">
          <a class="navbar-brand" href="/">News Map</a>
        </div>
        <div>
          <ul class="nav navbar-nav">
            <!-- <li class="active"><a href="#">Home</a></li> -->
            <li><a href="#">About</a></li><!-- TODO? create about page-->
          </ul>
        </div>
      </div>
    </nav>

    <div id="map-canvas"></div>

    <script>
      $('#map-canvas').css({'width':'100%','height':'50%'});
      google.maps.event.trigger(map-canvas, 'resize');
    </script>

    <button type="button" id="news_drawer_toggle_button">Toggle Drawer!</button>
    <button type="button" id="news_board_toggle_button">Toggle News Board!</button>
    <div><h5>(This White bar will be removed later.)</h5></div>
    <div id="click_position">Have not clicked</div>
    <script>
      $('#news_drawer_toggle_button').click(function() {
        toggleNewsDrawer();
      });

      $('#news_board_toggle_button').click(function() {
        toggleNewsBoard();
      });

      function updateClickPosition(lat, lng) {
        $('#click_position').html("Click position: (" + lat + "," + lng + ")");
      }
    </script>

    <div id="news_drawer">
    <h1 class="landmark">台北市政府</h1>
    <ul id="article_list">
      <!-- -->
    </ul>
    </div>
    <script>
      function toggleNewsDrawer() {
        $('#news_drawer').slideToggle();
      }

      function onArticleItemClick(article_id) {
        loadNewsAjax(article_id);
      }

      function updateNewsDrawer(articles) {
        var htmlstr = "";
        for (i in articles) {
          var title = articles[i]["title"];
          var id = articles[i]["news_id"];

          htmlstr += '<li><a onclick="onArticleItemClick(\'' + id + '\')">'+title+'</a></li>';
        }
        $("#article_list").html(htmlstr);
      }

      function queryLocationAjax(lat, lng) {
        $.ajax({url: "query_landmark?lat=" + lat + "&lng=" + lng,
          success: function(result){
            json = JSON.parse(result);
            updateNewsDrawer(json);
        }});
      }

      // TODO querylocation from click point.
      queryLocationAjax(25.0173405, 121.5397518); // query NTU

    </script>

    <div id="news_board" class="news_board">
    <h1 id="news_title"></h1> <!-- fill when select article -->
    <div id="datetime"></div> <!-- fill when select article -->
    <p id="article"> <!-- fill when select article -->
    <img id="image_url" src=""> <!-- fill when select article -->
    <p id="popularity"></p> <!-- fill when select article -->
    <a href='' id="url" target="_blank">原文連結</a> <!-- fill when select article -->
    </div>
    <script>
      function toggleNewsBoard() {
        $("#news_board").slideToggle();
      }
    </script>

    <script>
      function write_to_news_board(title, datetime, article, popularity, image_url, url) {
        $("#news_title").html(title);
        $("#datetime").html(datetime);
        $("#article").html(article);
        $("#image_url").attr('src', image_url).load(function(){ this.width;});
        $("#popularity").html(popularity);
        $("#url").attr('href', url);
      }

      function loadNewsAjax(news_id) {
        $.ajax({url: "query_article?news_key=" + news_id,
          success: function(result){
            json = JSON.parse(result);
            var title = json['title'];
            var datetime = json['datetime'];
            var article = json['article'];
            var popularity = json['popularity'];
            var image_url = json['image_url'];
            var url = json['url'];

            write_to_news_board(title, datetime, article, popularity, image_url, url);
        }});
      }

      // TODO disable when click map.
    </script>
  </body>
</html>
